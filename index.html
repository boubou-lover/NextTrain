<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NextTrain</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Roboto', 'Google Sans', -apple-system, sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #334155 100%);
            min-height: 100vh;
            padding: 0;
            margin: 0;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .header {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            padding: 32px 20px 24px 20px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.25);
            color: white;
        }
        
        .header h1 {
            font-size: 36px;
            color: white;
            margin-bottom: 8px;
            font-weight: 700;
            letter-spacing: -1px;
        }
        
        .station-selector {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .station-name {
            color: rgba(255,255,255,0.9);
            font-size: 16px;
            flex: 1;
            font-weight: 500;
        }
        
        .locate-btn {
            background: rgba(255,255,255,0.25);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
            backdrop-filter: blur(10px);
        }
        
        .locate-btn:hover {
            background: rgba(255,255,255,0.35);
        }
        
        .locate-btn:disabled {
            background: rgba(255,255,255,0.15);
            cursor: not-allowed;
        }
        
        .manual-select {
            width: 100%;
            padding: 12px 16px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            margin-bottom: 16px;
            background: rgba(255,255,255,0.25);
            color: white;
            backdrop-filter: blur(10px);
            font-weight: 500;
        }
        
        .manual-select option, .manual-select optgroup {
            background: #1976d2;
            color: white;
        }
        
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .tab {
            flex: 1;
            background: rgba(255,255,255,0.2);
            color: rgba(255,255,255,0.9);
            border: none;
            padding: 12px 16px;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            backdrop-filter: blur(10px);
        }
        
        .tab.active {
            background: white;
            color: #1e3a8a;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transform: scale(1.02);
        }
        
        .tab:hover:not(.active) {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        
        .refresh-btn {
            background: white;
            color: #1e3a8a;
            border: none;
            padding: 14px 24px;
            border-radius: 28px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .refresh-btn:hover {
            box-shadow: 0 6px 20px rgba(0,0,0,0.25);
            transform: translateY(-2px);
        }
        
        .refresh-btn:disabled {
            background: rgba(255,255,255,0.5);
            cursor: not-allowed;
            transform: none;
        }
        
        .trains {
            background: white;
            margin: 12px;
            border-radius: 24px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .train-item {
            padding: 18px 20px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .train-item:hover {
            background: linear-gradient(90deg, #f1f5f9 0%, #ffffff 100%);
        }
        
        .train-item.expanded {
            background: #f1f5f9;
            flex-direction: column;
            align-items: stretch;
        }
        
        .train-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        
        .train-item:last-child {
            border-bottom: none;
        }
        
        .train-left {
            flex: 1;
        }
        
        .train-number {
            font-size: 18px;
            font-weight: 700;
            color: #1e40af;
            margin-bottom: 4px;
            letter-spacing: -0.3px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .alert-badge {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 700;
            box-shadow: 0 2px 6px rgba(255,107,107,0.3);
        }
        
        .occupancy-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .occupancy-low {
            background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%);
            color: white;
            box-shadow: 0 2px 6px rgba(81,207,102,0.3);
        }
        
        .occupancy-medium {
            background: linear-gradient(135deg, #ffd43b 0%, #fab005 100%);
            color: #000;
            box-shadow: 0 2px 6px rgba(255,212,59,0.3);
        }
        
        .occupancy-high {
            background: linear-gradient(135deg, #ff6b6b 0%, #fa5252 100%);
            color: white;
            box-shadow: 0 2px 6px rgba(255,107,107,0.3);
        }
        
        .train-details {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e0e0e0;
            display: none;
        }
        
        .train-item.expanded .train-details {
            display: block;
        }
        
        .detail-section {
            margin-bottom: 16px;
        }
        
        .detail-section:last-child {
            margin-bottom: 0;
        }
        
        .detail-title {
            font-size: 13px;
            font-weight: 600;
            color: #424242;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .detail-content {
            font-size: 13px;
            color: #757575;
            line-height: 1.6;
        }
        
        .stops-list {
            display: flex;
            flex-direction: column;
            gap: 0;
            margin-top: 16px;
            position: relative;
            padding: 0;
        }
        
        .stop-item {
            display: flex;
            align-items: center;
            padding: 12px 16px 12px 48px;
            position: relative;
            transition: background 0.2s;
        }
        
        .stop-item:hover .stop-name {
            color: #212121;
        }
        
        .stop-item::before {
            content: '';
            position: absolute;
            left: 22px;
            top: 0;
            bottom: 0;
            width: 4px;
            background: #4caf50;
            z-index: 0;
        }
        
        .stop-item:first-child::before {
            top: 50%;
            border-radius: 4px 4px 0 0;
        }
        
        .stop-item:last-child::before {
            bottom: 50%;
            border-radius: 0 0 4px 4px;
        }
        
        .stop-dot {
            position: absolute;
            left: 16px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            border: 4px solid #4caf50;
            z-index: 1;
            transition: all 0.2s;
        }
        
        .stop-item.current-station {
            background: #f1f8e9;
        }
        
        .stop-item.current-station .stop-dot {
            border-color: #212121;
            background: #212121;
            width: 20px;
            height: 20px;
            left: 14px;
            box-shadow: 0 0 0 4px rgba(33, 33, 33, 0.1);
        }
        
        .stop-item.terminus .stop-dot {
            border-color: #212121;
            background: #212121;
            width: 18px;
            height: 18px;
            left: 15px;
        }
        
        .stop-name {
            font-size: 15px;
            color: #424242;
            font-weight: 400;
            cursor: pointer;
            transition: color 0.2s;
            flex: 1;
        }
        
        .stop-item.current-station .stop-name {
            font-weight: 700;
            color: #212121;
            font-size: 16px;
        }
        
        .stop-item.terminus .stop-name {
            font-weight: 600;
            font-size: 15px;
        }
        
        .stop-time {
            font-size: 13px;
            color: #757575;
            margin-left: auto;
            padding-left: 16px;
            font-weight: 500;
            min-width: 50px;
            text-align: right;
        }
        
        .stop-item.current-station .stop-time {
            color: #212121;
            font-weight: 600;
        }
        
        .stop-platform {
            font-size: 11px;
            color: #9e9e9e;
            margin-left: 12px;
            background: #f5f5f5;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 500;
        }
        
        .stop-item.current-station .stop-platform {
            background: #212121;
            color: white;
        }
        
        .composition-icons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 8px;
        }
        
        .composition-icon {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            color: #616161;
        }
        
        .composition-card {
            background: #f5f5f5;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            border-left: 4px solid #212121;
        }
        
        .composition-header {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 6px;
            color: #212121;
        }
        
        .composition-details {
            font-size: 12px;
            color: #616161;
            line-height: 1.7;
        }
        
        .composition-summary {
            margin-top: 12px;
            padding: 10px;
            background: #e8f5e9;
            border-radius: 6px;
            font-size: 12px;
            color: #2e7d32;
            font-weight: 500;
        }
        
        .composition-compact {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }
        
        .wagon-chip {
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 13px;
            color: #475569;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            border: 2px solid transparent;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }
        
        .wagon-chip:hover {
            background: linear-gradient(135deg, #1e3a8a 0%, #334155 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(30,58,138,0.4);
        }
        
        .wagon-chip.expanded {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(30,58,138,0.4);
            transform: scale(1.05);
        }
        
        .wagon-details {
            display: none;
            margin-top: 12px;
            padding: 12px;
            background: #f5f5f5;
            border-radius: 8px;
            border-left: 4px solid #212121;
        }
        
        .wagon-details.visible {
            display: block;
        }
        
        .wagon-details-header {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 8px;
            color: #212121;
        }
        
        .wagon-details-content {
            font-size: 12px;
            color: #616161;
            line-height: 1.7;
        }
        
        .expand-icon {
            font-size: 12px;
            color: #9e9e9e;
            transition: transform 0.3s;
        }
        
        .train-item.expanded .expand-icon {
            transform: rotate(180deg);
        }
        
        .disturbances-banner {
            background: linear-gradient(135deg, #fff3cd 0%, #ffe8a1 100%);
            border-left: 5px solid #ffc107;
            padding: 14px 18px;
            margin: 12px;
            border-radius: 16px;
            font-size: 13px;
            color: #856404;
            line-height: 1.6;
            box-shadow: 0 2px 8px rgba(255,193,7,0.2);
        }
        
        .disturbances-banner strong {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
        }
        
        .destination {
            font-size: 15px;
            color: #424242;
            margin-bottom: 2px;
            font-weight: 400;
        }
        
        .route-info {
            font-size: 12px;
            color: #757575;
            margin-bottom: 4px;
            font-weight: 400;
        }
        
        .platform {
            font-size: 13px;
            color: #757575;
            font-weight: 400;
        }
        
        .train-right {
            text-align: right;
        }
        
        .time {
            font-size: 26px;
            font-weight: 700;
            color: #212121;
            letter-spacing: -0.5px;
        }
        
        .delay {
            font-size: 13px;
            color: #ff6b6b;
            margin-top: 4px;
            font-weight: 600;
        }
        
        .delay.on-time {
            color: #51cf66;
        }
        
        .loading {
            padding: 48px 20px;
            text-align: center;
            color: #757575;
        }
        
        .error {
            padding: 20px;
            background: #ffebee;
            color: #c62828;
            border-radius: 12px;
            margin: 12px;
            font-size: 14px;
        }
        
        .info {
            padding: 20px;
            background: #f5f5f5;
            color: #424242;
            border-radius: 12px;
            margin: 12px;
            font-size: 14px;
            line-height: 1.6;
            border: 1px solid #e0e0e0;
        }
        
        .success {
            padding: 16px 20px;
            background: #e8f5e9;
            color: #2e7d32;
            font-size: 14px;
            margin-bottom: 12px;
            border-radius: 12px;
            font-weight: 500;
        }
        
        .download-btn {
            background: #212121;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 12px;
            display: inline-block;
            text-decoration: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }
        
        .download-btn:hover {
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transform: translateY(-1px);
        }
        
        .last-update {
            padding: 16px 20px;
            text-align: center;
            font-size: 13px;
            color: #757575;
            background: #fafafa;
            font-weight: 400;
        }
        
        .footer {
            background: white;
            margin: 12px;
            margin-top: 16px;
            border-radius: 24px;
            padding: 20px 20px;
            text-align: center;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }
        
        .footer .version {
            font-size: 13px;
            color: #667eea;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .footer .credits {
            font-size: 11px;
            color: #bdbdbd;
            line-height: 1.5;
        }
        
        .footer a {
            color: #424242;
            text-decoration: none;
        }
        
        .footer a:hover {
            text-decoration: underline;
        }
        
        .spinner {
            border: 4px solid rgba(102,126,234,0.2);
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 0.8s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>NextTrain</h1>
            <div class="station-selector">
                <div class="station-name" id="stationName">üìç Libramont</div>
                <button class="locate-btn" onclick="findNearestStation()" id="locateBtn">
                    <span>üìç</span>
                    <span>Localiser</span>
                </button>
            </div>
            <select class="manual-select" id="stationSelect" onchange="onStationChange()">
                <option value="">Choisir une gare...</option>
            </select>
            <div class="tabs">
                <button class="tab active" onclick="switchTab('departure')" id="departureTab">
                    <span>üöÄ</span>
                    <span>D√©parts</span>
                </button>
                <button class="tab" onclick="switchTab('arrival')" id="arrivalTab">
                    <span>üèÅ</span>
                    <span>Arriv√©es</span>
                </button>
            </div>
            <button class="refresh-btn" onclick="loadTrains()" id="refreshBtn">
                <span>üîÑ</span>
                <span>Actualiser</span>
            </button>
        </div>
        <div class="trains" id="trainsContainer">
            <div class="loading">
                <div class="spinner"></div>
                <p style="margin-top: 12px;">Chargement...</p>
            </div>
        </div>
        <div class="footer">
            <div class="version">Version 1.2.0 - Novembre 2025</div>
            <div class="credits">
                Donn√©es en temps r√©el via <a href="https://api.irail.be" target="_blank">iRail API</a><br>
                Outil pour les conducteurs SNCB üöÇ
            </div>
        </div>
    </div>

    <script>
        let autoRefreshInterval;
        let currentMode = 'departure';
        let currentStation = 'Libramont';
        let allStations = [];
        let disturbances = [];
        let expandedTrains = new Set();
        let trainDetailsCache = {};
        
        // Gares IC uniquement + Neufch√¢teau
        const stationsByLine = {
            'Ligne L162 (Luxembourg-Bruxelles)': [
                'Libramont', 'Arlon', 'Neufch√¢teau', 'Jemelle', 
                'Marloie', 'Ciney', 'Namur', 'Luxembourg'
            ],
            'Ligne L161 (Bruxelles-Namur)': [
                'Bruxelles-Luxembourg', 'Ottignies', 'Gembloux', 'Namur'
            ],
            'Ligne L34 (Li√®ge)': [
                'Li√®ge-Guillemins'
            ],
            'Autres gares IC': [
                'Bruxelles-Midi', 'Bruxelles-Central', 'Bruxelles-Nord',
                'Antwerpen-Centraal', 'Gent-Sint-Pieters', 'Charleroi-Sud',
                'Bruges', 'Leuven', 'Mons', 'Tournai', 'Mechelen', 'Hasselt',
                'Kortrijk', 'Oostende'
            ]
        };
        
        function initStationSelect() {
            const select = document.getElementById('stationSelect');
            
            // Ajouter les gares par cat√©gorie
            Object.keys(stationsByLine).forEach(category => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = category;
                
                stationsByLine[category].forEach(station => {
                    const option = document.createElement('option');
                    option.value = station;
                    option.textContent = station;
                    if (station === currentStation) {
                        option.selected = true;
                    }
                    optgroup.appendChild(option);
                });
                
                select.appendChild(optgroup);
            });
        }
        
        function onStationChange() {
            const select = document.getElementById('stationSelect');
            if (select.value) {
                currentStation = select.value;
                document.getElementById('stationName').textContent = `üìç ${currentStation}`;
                loadTrains();
            }
        }
        
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('fr-BE', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            return timeString;
        }
        
        function switchTab(mode) {
            currentMode = mode;
            document.getElementById('departureTab').classList.toggle('active', mode === 'departure');
            document.getElementById('arrivalTab').classList.toggle('active', mode === 'arrival');
            expandedTrains.clear(); // Fermer tous les trains expand√©s
            loadTrains();
        }
        
        function changeStation(stationName) {
            currentStation = stationName;
            document.getElementById('stationName').textContent = `üìç ${stationName}`;
            
            // Mettre √† jour le select
            const select = document.getElementById('stationSelect');
            select.value = stationName;
            
            // R√©initialiser et recharger
            expandedTrains.clear();
            trainDetailsCache = {};
            loadTrains();
        }
        
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Rayon de la Terre en km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        async function findNearestStation() {
            const container = document.getElementById('trainsContainer');
            const locateBtn = document.getElementById('locateBtn');
            
            if (!navigator.geolocation) {
                container.innerHTML = `
                    <div class="error">
                        <strong>Erreur:</strong> La g√©olocalisation n'est pas disponible sur votre appareil.
                    </div>
                `;
                return;
            }
            
            locateBtn.disabled = true;
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p style="margin-top: 12px;">Recherche de la gare la plus proche...</p></div>';
            
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const userLat = position.coords.latitude;
                    const userLon = position.coords.longitude;
                    
                    try {
                        const response = await fetch('https://api.irail.be/stations/?format=json&lang=fr');
                        if (!response.ok) throw new Error('API error');
                        
                        const data = await response.json();
                        const stations = data.station;
                        
                        let nearestStation = null;
                        let minDistance = Infinity;
                        
                        stations.forEach(station => {
                            const distance = calculateDistance(
                                userLat, userLon,
                                parseFloat(station.locationY),
                                parseFloat(station.locationX)
                            );
                            
                            if (distance < minDistance) {
                                minDistance = distance;
                                nearestStation = station;
                            }
                        });
                        
                        if (nearestStation) {
                            currentStation = nearestStation.standardname;
                            document.getElementById('stationName').textContent = `üìç ${currentStation}`;
                            
                            const select = document.getElementById('stationSelect');
                            select.value = currentStation;
                            
                            container.innerHTML = `
                                <div class="success">
                                    ‚úÖ Gare la plus proche trouv√©e : <strong>${currentStation}</strong> (${minDistance.toFixed(1)} km)
                                </div>
                            `;
                            
                            setTimeout(() => loadTrains(), 1000);
                        }
                    } catch (error) {
                        console.error('Erreur:', error);
                        showTestMode();
                    } finally {
                        locateBtn.disabled = false;
                    }
                },
                (error) => {
                    console.error('G√©olocalisation refus√©e:', error);
                    container.innerHTML = `
                        <div class="error">
                            <strong>Erreur:</strong> Impossible d'acc√©der √† votre position. 
                            Veuillez autoriser la g√©olocalisation dans les param√®tres de votre navigateur.
                        </div>
                    `;
                    locateBtn.disabled = false;
                }
            );
        }
        
        function formatTime(timestamp) {
            const date = new Date(timestamp * 1000);
            return date.toLocaleTimeString('fr-BE', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }
        
        function formatDelay(delaySeconds) {
            if (delaySeconds === 0) {
                return '<span class="delay on-time">√Ä l\'heure</span>';
            }
            const delayMinutes = Math.floor(delaySeconds / 60);
            return `<span class="delay">+${delayMinutes} min</span>`;
        }
        
        function getOccupancyBadge(occupancy) {
            if (!occupancy || !occupancy.name || occupancy.name === 'unknown') {
                return '';
            }
            
            const occupancyMap = {
                'low': { class: 'occupancy-low', text: 'üü¢ Peu rempli' },
                'medium': { class: 'occupancy-medium', text: 'üü° Normal' },
                'high': { class: 'occupancy-high', text: 'üî¥ Bond√©' }
            };
            
            const info = occupancyMap[occupancy.name];
            if (!info) return '';
            
            return `<span class="occupancy-badge ${info.class}">${info.text}</span>`;
        }
        
        async function loadTrainDetails(vehicleId, date) {
            const cacheKey = `${vehicleId}_${date}`;
            if (trainDetailsCache[cacheKey]) {
                return trainDetailsCache[cacheKey];
            }
            
            try {
                const dateStr = date || getDateString();
                const [vehicleResponse, compositionResponse] = await Promise.all([
                    fetch(`https://api.irail.be/vehicle/?id=${encodeURIComponent(vehicleId)}&format=json&lang=fr&date=${dateStr}`),
                    fetch(`https://api.irail.be/composition/?id=${encodeURIComponent(vehicleId)}&format=json&date=${dateStr}`)
                ]);
                
                const details = {
                    vehicle: vehicleResponse.ok ? await vehicleResponse.json() : null,
                    composition: compositionResponse.ok ? await compositionResponse.json() : null
                };
                
                trainDetailsCache[cacheKey] = details;
                return details;
            } catch (error) {
                console.error('Erreur chargement d√©tails:', error);
                return { vehicle: null, composition: null };
            }
        }
        
        function getDateString(date) {
            const d = date || new Date();
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = String(d.getFullYear()).slice(-2);
            return day + month + year;
        }
        
        function toggleWagonDetails(wagonIndex, trainElement) {
            const wagonChip = trainElement.querySelector(`.wagon-chip[data-wagon="${wagonIndex}"]`);
            const wagonDetails = trainElement.querySelector(`.wagon-details[data-wagon="${wagonIndex}"]`);
            
            if (!wagonChip || !wagonDetails) return;
            
            const isVisible = wagonDetails.classList.contains('visible');
            
            if (isVisible) {
                wagonDetails.classList.remove('visible');
                wagonChip.classList.remove('expanded');
            } else {
                // Fermer tous les autres d√©tails de wagons dans ce train
                trainElement.querySelectorAll('.wagon-details').forEach(d => d.classList.remove('visible'));
                trainElement.querySelectorAll('.wagon-chip').forEach(c => c.classList.remove('expanded'));
                
                // Ouvrir celui-ci
                wagonDetails.classList.add('visible');
                wagonChip.classList.add('expanded');
            }
        }
        
        async function toggleTrainDetails(trainElement, vehicleId, date) {
            const isExpanded = expandedTrains.has(vehicleId);
            
            if (isExpanded) {
                expandedTrains.delete(vehicleId);
                trainElement.classList.remove('expanded');
                return;
            }
            
            expandedTrains.add(vehicleId);
            trainElement.classList.add('expanded');
            
            const detailsDiv = trainElement.querySelector('.train-details');
            detailsDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #9e9e9e;">Chargement des d√©tails...</div>';
            
            const details = await loadTrainDetails(vehicleId, date);
            
            let html = '';
            
            // Intermediate stops
            if (details.vehicle && details.vehicle.stops && details.vehicle.stops.stop) {
                const stops = details.vehicle.stops.stop;
                if (stops.length > 0) {
                    html += `
                        <div class="detail-section">
                            <div class="detail-title">üõë Itin√©raire du train (${stops.length} arr√™ts)</div>
                            <div class="stops-list">
                                ${stops.map((stop, index) => {
                                    const isFirst = index === 0;
                                    const isLast = index === stops.length - 1;
                                    const isCurrent = stop.stationinfo.standardname === currentStation || 
                                                     stop.stationinfo.name === currentStation;
                                    
                                    const stopTime = formatTime(stop.scheduledDepartureTime || stop.scheduledArrivalTime || stop.time);
                                    const platform = stop.platform || stop.platforminfo?.name || '';
                                    const stationName = stop.stationinfo.name;
                                    const standardName = stop.stationinfo.standardname;
                                    
                                    const classes = ['stop-item'];
                                    if (isCurrent) classes.push('current-station');
                                    if (isFirst || isLast) classes.push('terminus');
                                    
                                    return `
                                        <div class="${classes.join(' ')}">
                                            <div class="stop-dot"></div>
                                            <div class="stop-name" onclick="event.stopPropagation(); changeStation('${standardName}')" title="Cliquez pour voir les horaires de ${stationName}">
                                                ${stationName}
                                            </div>
                                            ${platform ? `<span class="stop-platform">Quai ${platform}</span>` : ''}
                                            <div class="stop-time">${stopTime}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }
            }
            
            // Composition
            if (details.composition && details.composition.composition && 
                details.composition.composition.segments && 
                details.composition.composition.segments.segment) {
                
                const segment = details.composition.composition.segments.segment[0];
                if (segment && segment.composition && segment.composition.units) {
                    const units = segment.composition.units.unit;
                    
                    html += `
                        <div class="detail-section">
                            <div class="detail-title">üöÉ Composition (${units.length} voiture${units.length > 1 ? 's' : ''})</div>
                            <div class="composition-compact">
                                ${units.map((unit, index) => {
                                    const materialType = unit.materialType?.parent_type || 'N/A';
                                    const subType = unit.materialType?.sub_type || '';
                                    const materialNumber = unit.materialNumber || 'N/A';
                                    
                                    return `<div class="wagon-chip" data-wagon="${index}" onclick="event.stopPropagation(); toggleWagonDetails(${index}, this.closest('.train-item'))">
                                        ${materialType}${subType ? `-${subType}` : ''} #${materialNumber}
                                    </div>`;
                                }).join('')}
                            </div>
                            ${units.map((unit, index) => {
                                const materialType = unit.materialType?.parent_type || 'N/A';
                                const subType = unit.materialType?.sub_type || '';
                                const materialNumber = unit.materialNumber || 'N/A';
                                const orientation = unit.materialType?.orientation || '';
                                const tractionType = unit.tractionType || '';
                                
                                // Calcul des places
                                const seatsFirst = parseInt(unit.seatsFirstClass) || 0;
                                const seatsSecond = parseInt(unit.seatsSecondClass) || 0;
                                const totalSeats = seatsFirst + seatsSecond;
                                
                                return `
                                    <div class="wagon-details" data-wagon="${index}">
                                        <div class="wagon-details-header">
                                            Voiture ${index + 1} - ${materialType}${subType ? `-${subType}` : ''} #${materialNumber}
                                        </div>
                                        <div class="wagon-details-content">
                                            ${tractionType ? `‚Ä¢ Type: ${tractionType}<br>` : ''}
                                            ${orientation ? `‚Ä¢ Orientation: ${orientation}<br>` : ''}
                                            ‚Ä¢ Places: ${totalSeats} (1√®re: ${seatsFirst}, 2√®me: ${seatsSecond})
                                            ${parseInt(unit.standingPlacesSecondClass) > 0 ? `<br>‚Ä¢ Places debout: ${unit.standingPlacesSecondClass}` : ''}
                                            ${unit.lengthInMeter ? `<br>‚Ä¢ Longueur: ${unit.lengthInMeter}m` : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                            <div class="composition-summary">
                                <strong>Total:</strong> ${units.length} voiture${units.length > 1 ? 's' : ''} - 
                                ${units.reduce((sum, u) => sum + (parseInt(u.seatsFirstClass) || 0) + (parseInt(u.seatsSecondClass) || 0), 0)} places assises
                            </div>
                        </div>
                    `;
                }
            }
            
            if (!html) {
                html = '<div style="text-align: center; padding: 20px; color: #9e9e9e;">D√©tails non disponibles</div>';
            }
            
            detailsDiv.innerHTML = html;
        }
        
        async function loadDisturbances() {
            try {
                const response = await fetch('https://api.irail.be/disturbances/?format=json&lang=fr');
                if (response.ok) {
                    const data = await response.json();
                    disturbances = data.disturbance || [];
                }
            } catch (error) {
                console.error('Erreur chargement perturbations:', error);
            }
        }
        
        function showDisturbancesBanner() {
            if (disturbances.length === 0) return '';
            
            const relevantDisturbances = disturbances.filter(d => 
                d.type === 'disturbance' || 
                (d.title && (d.title.toLowerCase().includes(currentStation.toLowerCase()) ||
                            d.description && d.description.toLowerCase().includes(currentStation.toLowerCase())))
            ).slice(0, 3);
            
            if (relevantDisturbances.length === 0) return '';
            
            return `
                <div class="disturbances-banner">
                    <strong>‚ö†Ô∏è Perturbations signal√©es</strong>
                    ${relevantDisturbances.map(d => `<div>‚Ä¢ ${d.title}</div>`).join('')}
                </div>
            `;
        }
        
        function showTestMode() {
            const now = Math.floor(Date.now() / 1000);
            
            const mockData = {
                [currentMode + 's']: {
                    number: 5,
                    [currentMode]: [
                        {
                            time: now + 300,
                            delay: 0,
                            vehicle: "IC2738",
                            vehicleinfo: { shortname: "IC2738" },
                            station: currentMode === 'departure' ? "Bruxelles-Midi" : "Luxembourg",
                            platform: "2",
                            canceled: "0",
                            direction: { name: currentMode === 'departure' ? "Bruxelles-Midi" : "Luxembourg" }
                        },
                        {
                            time: now + 1800,
                            delay: 180,
                            vehicle: "L5427",
                            vehicleinfo: { shortname: "L5427" },
                            station: currentMode === 'departure' ? "Arlon" : "Namur",
                            platform: "1",
                            canceled: "0",
                            direction: { name: currentMode === 'departure' ? "Arlon" : "Namur" }
                        },
                        {
                            time: now + 3600,
                            delay: 0,
                            vehicle: "IC2740",
                            vehicleinfo: { shortname: "IC2740" },
                            station: currentMode === 'departure' ? "Luxembourg" : "Bruxelles-Midi",
                            platform: "2",
                            canceled: "0",
                            direction: { name: currentMode === 'departure' ? "Luxembourg" : "Bruxelles-Midi" }
                        }
                    ]
                }
            };
            
            processTrainsData(mockData, currentMode);
        }
        
        function processTrainsData(data, mode) {
            const container = document.getElementById('trainsContainer');
            const refreshBtn = document.getElementById('refreshBtn');
            
            try {
                const trainsData = mode === 'departure' ? data.departures : data.arrivals;
                const trainsList = mode === 'departure' ? trainsData.departure : trainsData.arrival;
                
                if (!trainsData || trainsData.number === 0) {
                    container.innerHTML = `<div class="loading">Aucun ${mode === 'departure' ? 'd√©part' : 'arriv√©e'} programm√© actuellement</div>`;
                    return;
                }
                
                // Filtrer les trains futurs et les trier par heure
                const now = Math.floor(Date.now() / 1000);
                const futureTrains = trainsList.filter(train => {
                    const trainTime = parseInt(train.time);
                    return trainTime >= now;
                }).sort((a, b) => parseInt(a.time) - parseInt(b.time));
                
                // Si on n'a pas 10 trains, on affiche ce qu'on a
                const trains = futureTrains.slice(0, 10);
                
                if (trains.length === 0) {
                    container.innerHTML = `<div class="loading">Aucun ${mode === 'departure' ? 'd√©part' : 'arriv√©e'} pr√©vu pour le moment. Essayez de recharger plus tard.</div>`;
                    return;
                }
                
                let html = '';
                const today = new Date().setHours(0, 0, 0, 0);
                
                // Ajouter les perturbations
                html += showDisturbancesBanner();
                
                trains.forEach(train => {
                    const trainDate = new Date(parseInt(train.time) * 1000);
                    const trainDay = trainDate.setHours(0, 0, 0, 0);
                    const isTomorrow = trainDay > today;
                    
                    const time = formatTime(train.time);
                    const delay = formatDelay(train.delay);
                    const trainNumber = train.vehicleinfo.shortname || train.vehicle;
                    const destination = train.station;
                    const platform = train.platform;
                    const isCanceled = train.canceled === "1";
                    const vehicleId = train.vehicle;
                    const dateStr = getDateString(new Date(parseInt(train.time) * 1000));
                    
                    // Informations de direction
                    const direction = train.direction ? train.direction.name : '';
                    
                    let routeText = '';
                    if (mode === 'departure') {
                        routeText = direction ? `${currentStation} ‚Üí ${direction}` : `vers ${destination}`;
                    } else {
                        routeText = direction ? `${direction} ‚Üí ${currentStation}` : `de ${destination}`;
                    }
                    
                    // Ajouter indicateur "Demain" si n√©cessaire
                    const tomorrowBadge = isTomorrow ? '<span style="background: #ff9800; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 8px; font-weight: 500;">Demain</span>' : '';
                    
                    // Badge d'alerte si le train a des alertes
                    const hasAlerts = train.alerts && train.alerts.number > 0;
                    const alertBadge = hasAlerts ? '<span class="alert-badge">‚ö†Ô∏è</span>' : '';
                    
                    // Badge d'occupation
                    const occupancyBadge = getOccupancyBadge(train.occupancy);
                    
                    if (isCanceled) {
                        html += `
                            <div class="train-item" style="opacity: 0.5;">
                                <div class="train-item-header">
                                    <div class="train-left">
                                        <div class="train-number">${trainNumber}${tomorrowBadge}${alertBadge}</div>
                                        <div class="route-info">${routeText}</div>
                                        <div class="platform">Quai ${platform}</div>
                                    </div>
                                    <div class="train-right">
                                        <div class="time">${time}</div>
                                        <span class="delay">‚ùå Annul√©</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="train-item" onclick="toggleTrainDetails(this, '${vehicleId}', '${dateStr}')">
                                <div class="train-item-header">
                                    <div class="train-left">
                                        <div class="train-number">
                                            ${trainNumber}${tomorrowBadge}${alertBadge}
                                            ${occupancyBadge}
                                        </div>
                                        <div class="route-info">${routeText}</div>
                                        <div class="platform">Quai ${platform}</div>
                                    </div>
                                    <div class="train-right">
                                        <div class="time">${time}</div>
                                        ${delay}
                                        <div class="expand-icon">‚ñº</div>
                                    </div>
                                </div>
                                <div class="train-details"></div>
                            </div>
                        `;
                    }
                });
                
                html += `<div class="last-update">Mis √† jour √† ${updateCurrentTime()} - ${trains.length} train(s) affich√©(s)</div>`;
                
                container.innerHTML = html;
                
            } catch (error) {
                container.innerHTML = `
                    <div class="error">
                        <strong>Erreur:</strong> Impossible de traiter les donn√©es.
                    </div>
                `;
                console.error('Erreur:', error);
            } finally {
                refreshBtn.disabled = false;
            }
        }
        
        async function loadTrains() {
            const container = document.getElementById('trainsContainer');
            const refreshBtn = document.getElementById('refreshBtn');
            
            refreshBtn.disabled = true;
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p style="margin-top: 12px;">Chargement des horaires...</p></div>';
            
            // Charger les perturbations en parall√®le
            loadDisturbances();
            
            try {
                // Charger les trains d'aujourd'hui
                const todayResponse = await fetch(`https://api.irail.be/liveboard/?station=${encodeURIComponent(currentStation)}&format=json&lang=fr&arrdep=${currentMode}`);
                
                if (!todayResponse.ok) {
                    throw new Error('API error');
                }
                
                const todayData = await todayResponse.json();
                
                // V√©rifier si on a assez de trains futurs
                const now = Math.floor(Date.now() / 1000);
                const trainsKey = currentMode === 'departure' ? 'departure' : 'arrival';
                const todayTrains = todayData[currentMode + 's'] && todayData[currentMode + 's'][trainsKey] ? todayData[currentMode + 's'][trainsKey] : [];
                const futureTrains = todayTrains.filter(t => parseInt(t.time) >= now);
                
                console.log(`Trains aujourd'hui: ${todayTrains.length}, Trains futurs: ${futureTrains.length}`);
                
                // Si on a moins de 10 trains futurs, essayer de charger ceux de demain
                if (futureTrains.length < 10) {
                    try {
                        const tomorrow = new Date();
                        tomorrow.setDate(tomorrow.getDate() + 1);
                        
                        // Format date: ddmmyy (ex: 270125 pour 27 janvier 2025)
                        const day = String(tomorrow.getDate()).padStart(2, '0');
                        const month = String(tomorrow.getMonth() + 1).padStart(2, '0');
                        const year = String(tomorrow.getFullYear()).slice(-2);
                        const dateStr = day + month + year;
                        const timeStr = '0000';
                        
                        console.log(`Tentative de chargement des trains de demain avec date: ${dateStr} et heure: ${timeStr}`);
                        
                        const tomorrowUrl = `https://api.irail.be/liveboard/?station=${encodeURIComponent(currentStation)}&format=json&lang=fr&arrdep=${currentMode}&date=${dateStr}&time=${timeStr}`;
                        console.log(`URL demain: ${tomorrowUrl}`);
                        
                        const tomorrowResponse = await fetch(tomorrowUrl);
                        
                        if (tomorrowResponse.ok) {
                            const tomorrowData = await tomorrowResponse.json();
                            console.log('R√©ponse de demain:', tomorrowData);
                            
                            const tomorrowTrains = tomorrowData[currentMode + 's'] && tomorrowData[currentMode + 's'][trainsKey] ? tomorrowData[currentMode + 's'][trainsKey] : [];
                            
                            console.log(`Trains de demain charg√©s: ${tomorrowTrains.length}`);
                            
                            if (tomorrowTrains.length > 0) {
                                // Combiner les trains d'aujourd'hui et de demain
                                const allTrains = [...todayTrains, ...tomorrowTrains];
                                todayData[currentMode + 's'][trainsKey] = allTrains;
                                console.log(`Total trains apr√®s fusion: ${allTrains.length}`);
                            }
                        } else {
                            console.log('Erreur lors du chargement des trains de demain. Status:', tomorrowResponse.status);
                            const errorText = await tomorrowResponse.text();
                            console.log('Erreur d√©tails:', errorText);
                        }
                    } catch (error) {
                        console.log('Impossible de charger les trains de demain:', error);
                        // Continuer avec seulement les trains d'aujourd'hui
                    }
                }
                
                processTrainsData(todayData, currentMode);
                
            } catch (error) {
                console.error('Erreur de chargement:', error);
                container.innerHTML = `
                    <div class="info">
                        <strong>‚ö†Ô∏è Impossible de charger les donn√©es r√©elles</strong><br><br>
                        Ce widget doit √™tre utilis√© dans un navigateur web standard.<br><br>
                        <strong>Pour l'utiliser :</strong><br>
                        ‚Ä¢ T√©l√©chargez ce fichier HTML<br>
                        ‚Ä¢ Ouvrez-le avec votre navigateur<br><br>
                        <button class="download-btn" onclick="showTestMode()">üß™ Voir le mode d√©mo</button>
                    </div>
                `;
                refreshBtn.disabled = false;
            }
        }
        
        // Initialisation
        initStationSelect();
        loadTrains();
        
        // Actualiser automatiquement toutes les 60 secondes
        autoRefreshInterval = setInterval(() => {
            loadTrains();
        }, 60000);
        
        window.addEventListener('beforeunload', () => {
            clearInterval(autoRefreshInterval);
        });
    </script>
</body>
</html>